version: '3.9'

# Settings and configurations that are common for all containers
x-es-common: &es-common
  image: docker.elastic.co/elasticsearch/elasticsearch:${ELK_VERSION:-7.15.0}
  # restart: on-failure
  ports:
    - 9200
    - 9300
  configs:
    - source: elastic_config
      target: /usr/share/elasticsearch/config/elasticsearch.yml
  ulimits:
    memlock:
      soft: -1
      hard: -1

x-logstash-common: &logstash-common
  image: docker.elastic.co/logstash/logstash:${ELK_VERSION:-7.15.0}
  # restart: on-failure
  ports:
    - 5044
    - 5000
  configs:
    - source: logstash_config
      target: /usr/share/logstash/config/logstash.yml
    - source: logstash_pipeline
      target: /usr/share/logstash/pipeline/logstash.conf
  environment:
    LS_JAVA_OPT: -Xmx256m -Xms256m
    TZ: "Asia/Ho_Chi_Minh"

x-kibana-common: &kibana-common
  image: docker.elastic.co/kibana/kibana:${ELK_VERSION:-7.15.0}
  # restart: on-failure
  ports:
    - 5601
  configs:
    - source: kibana_config
      target: /usr/share/kibana/config/kibana.yml

configs:
  elastic_config:
    file: ../res/elasticsearch/elasticsearch_extended.yml
  kibana_config:
    file: ../res/kibana/kibana_extended.yml
  filebeat_es_config:
    file: ../res/filebeat/filebeat-es.yml

services:
  es01:
    <<: *es-common
    hostname: es01
    container_name: es01
    environment:
      - ELASTIC_PASSWORD=changeme
      - ES_JAVA_OPTS=-Xmx512m -Xms512m
      - discovery.type=single-node
    volumes:
      - ./data/es/01:/usr/share/elasticsearch/data
    ports:
      - 9200:9200

  kibana01:
    <<: *kibana-common
    hostname: kibana01
    container_name: kibana01
    ports:
      - 5601:5601

  filebeat_es:
    container_name: filebeat_es
    hostname: filebeat_es
    # restart: on-failure
    user: root
    image: docker.elastic.co/beats/filebeat:${ELK_VERSION:-7.15.0}
    configs:
      - source: filebeat_es_config
        target: /usr/share/filebeat/filebeat.yml
    volumes:
      - ./data/filebeat_es:/usr/share/filebeat/data
      - /var/log:/var/log:ro
    depends_on:
      - es01
      - kibana01

  elastic-agent:
    hostname: elastic-agent
    container_name: elastic-agent
    image: docker.elastic.co/beats/elastic-agent-complete:${ELK_VERSION:-7.15.0}
    # restart: on-failure
    user: root # note, synthetic browser monitors require this set to `elastic-agent`
    ports:
      - 8220
    environment:
      - FLEET_SERVER_ENABLE=true
      - FLEET_SERVER_ELASTICSEARCH_HOST=http://es01:9200
      - FLEET_SERVER_SERVICE_TOKEN=AAEAAWVsYXN0aWMvZmxlZXQtc2VydmVyL3Rva2VuLTE2MzI1ODk2OTc0MTM6M2NXYlBab1pTTTJGdnY2RnNKeENFQQ
    volumes:
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - es01
      - kibana01
